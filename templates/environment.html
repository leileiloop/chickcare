<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Environment | Chick Care</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Optional minor tweaks for card layout */
        .cardBox, .cardBox1 {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }
        .card {
            flex: 1;
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .card img {
            width: 50px;
            height: 50px;
        }
        .charts {
            margin: 20px 0;
        }
        .charts .chart {
            margin-bottom: 20px;
        }
        .EnviTable {
            margin: 20px 0;
        }
        .EnviTable table {
            width: 100%;
            border-collapse: collapse;
        }
        .EnviTable th, .EnviTable td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: center;
        }
    </style>
</head>
<body>
<div class="container">

    <!-- Sidebar Navigation -->
    <div class="navigation">
        <ul>
            <li>
                <a href="#">
                    <span class="icon"><img src="{{ url_for('static', filename='imgs/CC.png') }}"></span>
                    <span class="title1">Chick Care</span>
                </a>
            </li>
            <li><a href="/main_dashboard"><span class="icon"><ion-icon name="reorder-four-outline"></ion-icon></span><span class="title">Dashboard</span></a></li>
            <li><a href="/webcam"><span class="icon"><ion-icon name="stats-chart-outline"></ion-icon></span><span class="title">Growth Tracking</span></a></li>
            <li><a href="/feeding"><span class="icon"><ion-icon name="layers-outline"></ion-icon></span><span class="title">Supplies Stock</span></a></li>
            <li><a href="/environment" class="active"><span class="icon"><ion-icon name="cloudy-outline"></ion-icon></span><span class="title">Environment</span></a></li>
            <li><a href="/dashboard"><span class="icon"><ion-icon name="notifications-circle-outline"></ion-icon></span><span class="title">Notifications</span></a></li>
            <li><a href="/sanitization"><span class="icon"><ion-icon name="water-outline"></ion-icon></span><span class="title">Sanitization</span></a></li>
            {% if session['user_role'] == 'admin' %}
            <li><a href="/manage_users"><span class="icon"><ion-icon name="people-outline"></ion-icon></span><span class="title">Manage Users</span></a></li>
            {% endif %}
            <li><a href="/report"><span class="icon"><ion-icon name="file-tray-stacked-outline"></ion-icon></span><span class="title">Report</span></a></li>
            <li><a href="/login"><span class="icon"><ion-icon name="log-out-outline"></ion-icon></span><span class="title">Sign Out</span></a></li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="main">
        <div class="topbar">
            <div class="toggle"><ion-icon name="menu-outline"></ion-icon></div>
            <div class="datetime"><span id="displayDateTime"></span></div>

            <div class="iconn" onclick="toggleNotifi()">
                <img src="{{ url_for('static', filename='imgs/bell.png') }}" alt="">
                <span id="notificationCount">0</span>
            </div>
            <div class="notifi-box" id="box">
                <h2>Notifications <span id="notificationCount1">0</span></h2>
                <div class="notifi-item">
                    <div class="text" id="notificationItems"></div>
                </div>
            </div>

            <div class="user">
                <img src="{{ url_for('static', filename='imgs/admin.jpg') }}" alt="">
            </div>
        </div>

        <!-- Environment Status Cards -->
        <div class="status">
            <h1>Environment</h1>
            <div class="cardBox">
                <div class="card">
                    <div><div id="hum" class="numbers">--</div><div class="cardName">Humidity</div></div>
                    <div class="iconBx"><img src="{{ url_for('static', filename='imgs/humidity.png') }}"></div>
                </div>
                <div class="card">
                    <div><div id="temp" class="numbers">--</div><div class="cardName">Temperature</div></div>
                    <div class="iconBx"><img src="{{ url_for('static', filename='imgs/temperature.png') }}"></div>
                </div>
                <div class="card">
                    <div><div id="amm" class="numbers">--</div><div class="cardName">Ammonia</div></div>
                    <div class="iconBx"><img src="{{ url_for('static', filename='imgs/ammonia.jpg') }}"></div>
                </div>
            </div>

            <div class="cardBox1">
                <div class="card">
                    <div><div class="numbers" id="light1-status">--</div><div class="cardName">Light 1</div></div>
                    <div class="iconBx"><img id="light1" src="{{ url_for('static', filename='imgs/LightA.png') }}" alt="Light 1"></div>
                </div>
                <div class="card">
                    <div><div class="numbers" id="light2-status">--</div><div class="cardName">Light 2</div></div>
                    <div class="iconBx"><img id="light2" src="{{ url_for('static', filename='imgs/LightA.png') }}" alt="Light 2"></div>
                </div>
                <div class="card">
                    <div><div class="numbers" id="exhaustfan-status">--</div><div class="cardName">Exhaust Fan</div></div>
                    <div class="iconBx"><img id="exhaustfan" src="{{ url_for('static', filename='imgs/exhaust-fan.png') }}" alt="Exhaust Fan"></div>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="charts">
            <div class="chart">
                <h2>Temperature</h2>
                <canvas id="lineChart"></canvas>
            </div>
            <div class="chart">
                <h2>Humidity</h2>
                <canvas id="lineChart1"></canvas>
            </div>
        </div>

        <!-- Environment Table -->
        <div class="EnviTable">
            <table id="table-body2">
                <thead>
                    <tr>
                        <th>DateTime</th>
                        <th>Humidity</th>
                        <th>Temperature</th>
                        <th>Light 1</th>
                        <th>Light 2</th>
                        <th>Ammonia</th>
                        <th>Exhaust Fan</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

    </div>
</div>

<!-- Scripts -->
<script src="{{ url_for('static', filename='js/main.js') }}"></script>
<script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
<script>
    function toggleNotifi() {
        const box = document.getElementById('box');
        box.style.display = box.style.display === 'block' ? 'none' : 'block';
    }

    // Fetch environment data from backend
    async function loadEnvironment() {
        const res = await fetch('/api/environment');
        const data = await res.json();

        // Update cards
        document.getElementById('hum').innerText = data.humidity;
        document.getElementById('temp').innerText = data.temperature;
        document.getElementById('amm').innerText = data.ammonia;

        document.getElementById('light1-status').innerText = data.light1;
        document.getElementById('light2-status').innerText = data.light2;
        document.getElementById('exhaustfan-status').innerText = data.exhaustFan;

        // Update table
        const tbody = document.querySelector('#table-body2 tbody');
        tbody.innerHTML = '';
        data.records.forEach(r => {
            tbody.innerHTML += `<tr>
                <td>${r.datetime}</td>
                <td>${r.humidity}</td>
                <td>${r.temperature}</td>
                <td>${r.light1}</td>
                <td>${r.light2}</td>
                <td>${r.ammonia}</td>
                <td>${r.exhaustFan}</td>
            </tr>`;
        });

        // Update charts
        updateCharts(data.records);
    }

    let tempChart, humChart;
    function updateCharts(records) {
        const tempData = records.map(r => r.temperature);
        const humData = records.map(r => r.humidity);
        const labels = records.map(r => r.datetime);

        if (tempChart) tempChart.destroy();
        tempChart = new Chart(document.getElementById('lineChart').getContext('2d'), {
            type: 'line',
            data: { labels, datasets: [{ label: 'Temperature', data: tempData, borderColor: 'red', tension: 0.3 }] },
        });

        if (humChart) humChart.destroy();
        humChart = new Chart(document.getElementById('lineChart1').getContext('2d'), {
            type: 'line',
            data: { labels, datasets: [{ label: 'Humidity', data: humData, borderColor: 'blue', tension: 0.3 }] },
        });
    }

    loadEnvironment();
    setInterval(loadEnvironment, 10000); // Refresh every 10s
</script>
</body>
</html>
