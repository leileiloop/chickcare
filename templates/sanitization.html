<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sanitization</title>
        <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        /* Minimal CSS for the sanitization cards and buttons, assuming main styles handle layout */
        .status1 h1 { text-align: center; margin-bottom: 20px; }
        .cBox, .cBox1 { display: flex; justify-content: space-around; flex-wrap: wrap; gap: 20px; margin-bottom: 30px; }
        .cd { 
            background: #fff; 
            padding: 20px; 
            border-radius: 10px; 
            box-shadow: 0 7px 25px rgba(0, 0, 0, 0.08);
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            min-width: 250px;
            position: relative;
        }
        .num { font-size: 2.5em; font-weight: 500; color: var(--blue, #287bff); text-align: center; }
        .cName { color: #999; text-align: center; margin-bottom: 10px; }
        .icBx img { width: 80px; height: 80px; object-fit: contain; }
        .stop-btn {
            background-color: #f44336; /* Red color for emergency stop */
            color: white;
            border: none;
            padding: 10px 20px;
            margin-top: 15px;
            cursor: pointer;
            border-radius: 8px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .stop-btn:hover { background-color: #d32f2f; }

        .SanitizationTable table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .SanitizationTable th, .SanitizationTable td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .SanitizationTable thead th {
            background-color: var(--blue, #287bff);
            color: white;
        }
    </style>
</head>
<body>

        <div class="container">
        <div class="navigation">
            <ul>
                <li>
                    <a href="#">
                        <span class="icon">
                            <img src="static/imgs/CC.png" alt="Chick Care Logo">
                        </span>
                        <span class="title1">Chick Care</span>
                    </a>
                </li>

                                <li><a href="/main_dashboard"><span class="icon"><ion-icon name="reorder-four-outline"></ion-icon></span><span class="title">Dashboard</span></a></li>
                <li><a href="/webcam"><span class="icon"><ion-icon name="stats-chart-outline"></ion-icon></span><span class="title">Growth Tracking</span></a></li>
                <li><a href="/feeding"><span class="icon"><ion-icon name="layers-outline"></ion-icon></span><span class="title">Supplies Stock</span></a></li>
                <li><a href="/environment"><span class="icon"><ion-icon name="cloudy-outline"></ion-icon></span><span class="title">Environment</span></a></li>
                <li><a href="/dashboard"><span class="icon"><ion-icon name="notifications-circle-outline"></ion-icon></span><span class="title">Notifications</span></a></li>
                <li class="active">                     <a href="/sanitization">
                        <span class="icon">
                            <ion-icon name="water-outline"></ion-icon>
                        </span>
                        <span class="title">Sanitization</span>
                    </a>
                </li>
                {% if session['user_role'] == 'admin' %}
                <li><a href="/manage_users"><span class="icon"><ion-icon name="people-outline"></ion-icon></span><span class="title">Manage Users</span></a></li>
                {% endif %}
                <li><a href="/report"><span class="icon"><ion-icon name="file-tray-stacked-outline"></ion-icon></span><span class="title">Report</span></a></li>
                <li><a href="/logout"><span class="icon"><ion-icon name="log-out-outline"></ion-icon></span><span class="title">Sign Out</span></a></li>
            </ul>
        </div>

                <div class="main">
            <div class="topbar">
                <div class="toggle">
                    <ion-icon name="menu-outline"></ion-icon>
                </div>
                <div class="datetime">
                    <span id="displayDateTime"></span>
                </div>
                                <div class="iconn" onclick="toggleNotifi()"><img src="static/imgs/bell.png" alt="Notification Bell"> <span id="notificationCount">0</span></div>
                <div class="notifi-box" id="box"><h2>Notifications <span id="notificationCount1">0</span></h2><div class="notifi-item"><div class="text" id="notificationItems"></div></div></div>
                <div class="user"><img src="static/imgs/admin.jpg" alt="User Image"></div>
            </div>

                        <div class="status1">
                <h1>Sanitization System Control & Status</h1>
                <div class="cBox">

                    <div class="cd">
                        <div>
                                                        <div class="num" id="status_cvyr">OFF</div>
                            <div class="cName">Conveyor</div>
                        </div>

                        <div class="icBx">
                            <img class="convy" src="/static/imgs/conveyor.png" alt="Conveyor Icon">
                        </div>

                                                <button id="stopConveyor" class="stop-btn" data-device="conveyor">STOP</button>
                    </div>

                    <div class="cd">
                        <div>
                                                        <div class="num" id="sprkl">OFF</div>
                            <div class="cName">Sprinkle</div>
                        </div>

                        <div class="icBx">
                            <img class="sprink" src="/static/imgs/sprinkle.png" alt="Sprinkle Icon">
                        </div>

                                                <button id="stopSprinkle" class="stop-btn" data-device="sprinkle">STOP</button>
                    </div>
                
                                        <div class="cd">
                        <div>
                                                        <div class="num" id="uvc_status">OFF</div> 
                            <div class="cName">UVC Light</div>
                        </div>

                        <div class="icBx">
                            <img class="uvcl" id="uvcImage" src="{{ url_for('static', filename='imgs/UVCoff.png') }}" alt="UVC Light Status">
                        </div>

                                                <button id="stopUVLight" class="stop-btn" data-device="uvclight">STOP</button>
                    </div>
                </div>
                                                <h2>Sanitization Log</h2>
                <div id="table-body" class="SanitizationTable">
                    <table>
                        <thead>
                            <tr>
                                <th>DateTime</th>
                                <th>Conveyor</th>
                                <th>Sprinkle</th>
                                <th>UVLight</th>
                            </tr>
                        </thead>
                        <tbody id="sanitizationTableBody">
                                                    </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

        <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>

        <script src="{{ url_for('static', filename='js/main.js') }}" defer></script>
    
        <script>
        document.addEventListener('DOMContentLoaded', function() {
            const conveyorStatus = document.getElementById('status_cvyr');
            const sprinkleStatus = document.getElementById('sprkl');
            const uvcStatus = document.getElementById('uvc_status');
            const uvcImage = document.getElementById('uvcImage');
            const tableBody = document.getElementById('sanitizationTableBody');
            const stopButtons = document.querySelectorAll('.stop-btn');
            
            // Base path for static files (important for the UVC image update)
            const STATIC_PATH = '{{ url_for("static", filename="") }}'; 

            // --- 1. Function to Fetch and Update Component Status ---
            async function fetchStatus() {
                try {
                    // Replace with your actual Flask endpoint for status
                    const response = await fetch('/api/sanitization/status'); 
                    if (!response.ok) throw new Error('Network response was not ok');
                    const data = await response.json();

                    // Update Conveyor
                    conveyorStatus.textContent = data.conveyor ? 'ON' : 'OFF';
                    conveyorStatus.style.color = data.conveyor ? 'green' : 'red';
                    
                    // Update Sprinkle
                    sprinkleStatus.textContent = data.sprinkle ? 'ON' : 'OFF';
                    sprinkleStatus.style.color = data.sprinkle ? 'green' : 'red';

                    // Update UVC Light
                    const uvcIsOn = data.uvclight;
                    uvcStatus.textContent = uvcIsOn ? 'ON' : 'OFF';
                    uvcStatus.style.color = uvcIsOn ? 'green' : 'red';

                    // Update UVC Image (Corrected file paths using url_for/STATIC_PATH)
                    if (uvcIsOn) {
                        uvcImage.src = STATIC_PATH + 'imgs/UVCon.png';
                    } else {
                        uvcImage.src = STATIC_PATH + 'imgs/UVCoff.png';
                    }

                } catch (error) {
                    console.error('Error fetching sanitization status:', error);
                }
            }

            // --- 2. Function to Send Emergency Stop Command ---
            async function sendStopCommand(device) {
                const confirmStop = confirm(`Are you sure you want to STOP the ${device.toUpperCase()}?`);
                if (!confirmStop) return;

                try {
                    // Replace with your actual Flask endpoint for control
                    const response = await fetch('/api/sanitization/stop', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ device: device })
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        alert(`${device} successfully stopped: ${result.message}`);
                        fetchStatus(); // Refresh status immediately
                    } else {
                        alert(`Failed to stop ${device}: ${result.message}`);
                    }

                } catch (error) {
                    console.error('Error sending stop command:', error);
                    alert('An error occurred. Check console for details.');
                }
            }
            
            // --- 3. Function to Fetch and Populate Log Table ---
            async function fetchLog() {
                try {
                    // Replace with your actual Flask endpoint for history
                    const response = await fetch('/api/sanitization/history'); 
                    if (!response.ok) throw new Error('Network response was not ok');
                    const history = await response.json();
                    
                    tableBody.innerHTML = ''; // Clear existing rows

                    if (history.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No sanitization records found.</td></tr>';
                        return;
                    }

                    history.forEach(record => {
                        const row = tableBody.insertRow();
                        // Assuming the backend returns 'DateTime', 'Conveyor', 'Sprinkle', 'UVLight'
                        row.insertCell().textContent = record.DateTime;
                        row.insertCell().textContent = record.Conveyor ? 'ON' : 'OFF';
                        row.insertCell().textContent = record.Sprinkle ? 'ON' : 'OFF';
                        row.insertCell().textContent = record.UVLight ? 'ON' : 'OFF';
                    });

                } catch (error) {
                    console.error('Error fetching sanitization history:', error);
                    tableBody.innerHTML = '<tr><td colspan="4" style="color: red; text-align: center;">Failed to load history.</td></tr>';
                }
            }

            // --- 4. Event Listeners and Polling Setup ---
            
            // Attach click event to all stop buttons
            stopButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const device = this.getAttribute('data-device');
                    sendStopCommand(device);
                });
            });

            // Initial load and polling for real-time status
            fetchStatus();
            setInterval(fetchStatus, 5000); // Poll every 5 seconds for status

            // Load history once on page load
            fetchLog(); 
        });
        
        // The original UVC image function is now integrated into fetchStatus, 
        // but correcting the original snippet's ID issue for reference:
        /*
        function changeImage() {
            // Original error: using status_uvc which doesn't exist, must use the actual display element ID
            const status = document.getElementById('uvc_status').innerText; 
            const image = document.getElementById('uvcImage');
            // ... logic ...
        }
        */
    </script>
</body>
</html>
